= *Edge Image Builder*


.Common
- If you are in a non-Linux environment, then you are running `Podman` via a virtual machine. This machine is low on resources on its default settings and can cause `Edge Image Builder` to require unreasonable amount of time for resource intensive operations, such as the RPM resolution process. You will need to adjust the resources of the podman machine, either by using Podman Desktop (settings cogwheel -> podman machine edit icon) or directly  via the `podman-machine-set` https://docs.podman.io/en/stable/markdown/podman-machine-set.1.html[command]
- At this point in time, the `Edge Image Builder` is not able to build images in a cross architecture setup, i.e. you have to run it on:
  * `aarch64` systems (such as Apple Silicon) to build SL Micro `aarch64` images
  * `x86_64` systems (such as Intel) to build SL Micro `x86_64` images.


.Kubernetes
- Creating multi node Kubernetes clusters requires adjusting the `kubernetes` section in the definition file to:
  * list all server and agent nodes under `kubernetes.nodes` 
  * set a virtual IP address that would be used for all non-initializer nodes to join the cluster under `kubernetes.network.apiVIP`
  * optionally, set an API host to specify a domain address for accessing the cluster under `kubernetes.network.apiHost`
To learn more about this configuration, please refer to the https://github.com/suse-edge/edge-image-builder/blob/main/docs/building-images.md#kubernetes[Kubernetes section docs].


- `Edge Image Builder` relies on the hostnames of the different nodes to determine their Kubernetes type (`server` or `agent`). While this configuration is managed in the definition file, for the general networking setup of the machines we can utilize either DHCP or the https://github.com/suse-edge/nm-configurator[nm-configurator component].

.Simple example of image creation for a multi server node RKE2 cluster with Rancher Prime:
**definition file:**

[source]
apiVersion: 1.1
image:
  arch: aarch64
  imageType: iso
  baseImage: SL-Micro.aarch64-6.0-Base-SelfInstall-GM2.install.iso
  outputImageName: rke2-ha.iso
operatingSystem:
  isoConfiguration:
    installDevice: /dev/vda
  users:
    - username: root
      encryptedPassword: # Add an encrypted password [1]
      createHomeDir: true
    - username: george
      encryptedPassword: # Add an encrypted password [1]
      sshKeys:
        - # Add ssh key for user george
      createHomeDir: true
  keymap: us
  time:
    timezone: "Europe/Prague"
  kernelArgs: 
    - foo=bar # dummy value for testing
  packages:
    packageList:
      - lshw
    sccRegistrationCode: # Add your SCC Registration Code
kubernetes:
  version: v1.30.3+rke2r1
  network:
    apiVIP: api.cluster01.edge.suse.com
    apiHost: api.cluster01.edge.suse.com
  nodes: # Multi server cluster
    - hostname: node01.cluster01.edge.suse.com
      type: server
      initializer: true
    - hostname: node02.cluster01.edge.suse.com
      type: server
    - hostname: node03.cluster01.edge.suse.com
      type: server
  helm:
    charts:
      - name: cert-manager
        version: 1.16.1
        repositoryName: jetstack
        targetNamespace: cert-manager
        createNamespace: true
        valuesFile: cert-manager.yaml
      - name: rancher
        version: 2.9.1
        repositoryName: rancher-prime
        targetNamespace: cattle-system
        createNamespace: true
        valuesFile: rancher-prime.yaml
    repositories:
      - name: jetstack
        url: https://charts.jetstack.io
      - name: rancher-prime
        url: https://charts.rancher.com/server-charts/prime




[IMPORTANT]
====
. link:https://documentation.suse.com/suse-edge/3.1/html/edge/quickstart-eib.html#id-configuring-os-users[Create an encrypted password]
. Read more on link:https://github.com/suse-edge/edge-image-builder/blob/main/docs/building-images.md#network-configuration[Network Configuration]
====

**network files:**

[source]
-> file node01.cluster01.edge.suse.com:
interfaces:
- name: eth0
  type: ethernet
  state: up
  mac-address: 00:00:00:00:00:01
  ipv4:
    dhcp: true
    enabled: true
  ipv6:
    enabled: false
-> file node02.cluster01.edge.suse.com:
  interfaces:
- name: eth0
  type: ethernet
  state: up
  mac-address: 00:00:00:00:00:02
  ipv4:
    dhcp: true
    enabled: true
  ipv6:
    enabled: false
-> file node03.cluster01.edge.suse.com:
interfaces:
- name: eth0
  type: ethernet
  state: up
  mac-address: 00:00:00:00:00:03
  ipv4:
    dhcp: true
    enabled: true
  ipv6:
    enabled: false

**helm values files:**

[source]
-> cert-manager.yaml:
installCRDs: true
-> rancher-prime.yaml:
hostname: "node01.cluster01.edge.suse.com" 
replicas: 1
bootstrapPassword: Admin
global.cattle.psp.enabled: "false"

